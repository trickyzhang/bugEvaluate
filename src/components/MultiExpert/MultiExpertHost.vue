<template>
    <div class="vulnerability-assessment-container">
        <a-row :gutter="16">
            <a-col :span="14">
                <a-card title="æ¼æ´åŸºæœ¬ä¿¡æ¯" :bordered="false" class="card-section">
                    <a-form>
                        <a-row :gutter="16">
                            <a-col :span="12">
                                <a-form-item label="æ¼æ´ç¼–å·" :label-col="{ span: 8 }" :wrapper-col="{ span: 16 }">
                                    <span class="ant-form-text">{{ form.basic.cveID }}</span>
                                </a-form-item>
                            </a-col>
                            <a-col :span="12">
                                <a-form-item label="æ¼æ´ç±»å‹" :label-col="{ span: 8 }" :wrapper-col="{ span: 16 }">
                                    <span class="ant-form-text">{{ form.basic.cveType }}</span>
                                </a-form-item>
                            </a-col>
                            <a-col :span="12">
                                <a-form-item label="è½¯ä»¶ç±»å‹" :label-col="{ span: 8 }" :wrapper-col="{ span: 16 }">
                                    <span class="ant-form-text">{{ form.basic.softwareType }}</span>
                                </a-form-item>
                            </a-col>
                            <a-col :span="12">
                                <a-form-item label="æ¼æ´æ ‡é¢˜" :label-col="{ span: 8 }" :wrapper-col="{ span: 16 }">
                                    <span class="ant-form-text">{{ form.basic.cveTitle }}</span>
                                </a-form-item>
                            </a-col>
                            <a-col :span="24">
                                <a-form-item label="æè¿°" :label-col="{ span: 4 }" :wrapper-col="{ span: 20 }">
                                    <span class="ant-form-text">{{ form.basic.cveDescription }}</span>
                                </a-form-item>
                            </a-col>
                        </a-row>
                    </a-form>
                </a-card>

                <a-card title="å¨èƒæƒ…æŠ¥æ¥æº" :bordered="false" class="card-section">
                    <a-form>
                        <a-row :gutter="16">
                            <a-col :span="12">
                                <a-form-item label="æƒ…æŠ¥å­—æ®µ1" :label-col="{ span: 8 }" :wrapper-col="{ span: 16 }">
                                    <span class="ant-form-text">{{ form.threatIntelligence.field1 }}</span>
                                </a-form-item>
                            </a-col>
                            <a-col :span="12">
                                <a-form-item label="æƒ…æŠ¥å­—æ®µ2" :label-col="{ span: 8 }" :wrapper-col="{ span: 16 }">
                                    <span class="ant-form-text">{{ form.threatIntelligence.field2 }}</span>
                                </a-form-item>
                            </a-col>
                            <a-col :span="12">
                                <a-form-item label="æƒ…æŠ¥å­—æ®µ3" :label-col="{ span: 8 }" :wrapper-col="{ span: 16 }">
                                    <span class="ant-form-text">{{ form.threatIntelligence.field3 }}</span>
                                </a-form-item>
                            </a-col>
                        </a-row>
                    </a-form>
                </a-card>

                <a-card title="æ¼æ´åœ°åŸŸ" :bordered="false" class="card-section">
                    <a-form>
                        <a-row :gutter="16">
                            <a-col :span="12">
                                <a-form-item label="å­—æ®µ1" :label-col="{ span: 8 }" :wrapper-col="{ span: 16 }">
                                    <span class="ant-form-text">{{ form.religion.field1 }}</span>
                                </a-form-item>
                            </a-col>
                            <a-col :span="12">
                                <a-form-item label="å­—æ®µ2" :label-col="{ span: 8 }" :wrapper-col="{ span: 16 }">
                                    <span class="ant-form-text">{{ form.religion.field2 }}</span>
                                </a-form-item>
                            </a-col>
                        </a-row>
                    </a-form>
                </a-card>

                <a-card title="è‡ªåŠ¨åŒ–è½¯ä»¶æ¼æ´è¯„ä¼°ç»“æœ" :bordered="false" class="card-section">
                    <a-form>
                        <a-row :gutter="16">
                            <a-col :span="12">
                                <a-form-item label="æ¼æ´ä»·å€¼" :label-col="{ span: 8 }" :wrapper-col="{ span: 16 }">
                                    <span class="ant-form-text">{{ form.autoSoft.value || '-' }}</span>
                                </a-form-item>
                            </a-col>
                            <a-col :span="12">
                                <a-form-item label="æ¼æ´æ­¦å™¨" :label-col="{ span: 8 }" :wrapper-col="{ span: 16 }">
                                    <span class="ant-form-text">{{ form.autoSoft.weapon || '-' }}</span>
                                </a-form-item>
                            </a-col>
                            <a-col :span="12">
                                <a-form-item label="æ¼æ´æœåŠ¡" :label-col="{ span: 8 }" :wrapper-col="{ span: 16 }">
                                    <span class="ant-form-text">{{ form.autoSoft.service || '-' }}</span>
                                </a-form-item>
                            </a-col>
                            <a-col :span="12">
                                <a-form-item label="æ¼æ´å¯åˆ©ç”¨æ€§" :label-col="{ span: 8 }" :wrapper-col="{ span: 16 }">
                                    <span class="ant-form-text">{{ form.autoSoft.exploitability || '-' }}</span>
                                </a-form-item>
                            </a-col>
                        </a-row>
                    </a-form>
                    <div style="text-align: center; margin-top: 8px;">
                        <a-button type="primary" @click="showAlgorithmModal">ç¼–è¾‘ç®—æ³•</a-button>
                    </div>
                </a-card>

                <a-card title="è‡ªåŠ¨åŒ–è¯„ä¼°å¯è§£é‡Šæ€§åˆ†æç»“æœ" :bordered="false" class="card-section">
                    <a-form>
                        <a-row :gutter="16">
                            <a-col :span="12">
                                <a-form-item label="æ¼æ´ä»·å€¼" :label-col="{ span: 8 }" :wrapper-col="{ span: 16 }">
                                    <span class="ant-form-text">{{ form.explain.overallValue || '-' }}</span>
                                </a-form-item>
                            </a-col>
                            <a-col :span="12">
                                <a-form-item label="æš´éœ²åº¦" :label-col="{ span: 8 }" :wrapper-col="{ span: 16 }">
                                    <span class="ant-form-text">{{ form.explain.exposure || '-' }}</span>
                                </a-form-item>
                            </a-col>
                            <a-col :span="12">
                                <a-form-item label="æ¼æ´é£é™©" :label-col="{ span: 8 }" :wrapper-col="{ span: 16 }">
                                    <span class="ant-form-text">{{ form.explain.risk || '-' }}</span>
                                </a-form-item>
                            </a-col>
                        </a-row>
                    </a-form>
                    <div style="text-align: center; margin-top: 8px; display: flex; justify-content: center; gap: 16px;">
                        <a-button type="primary" @click="showExplainabilityModal">ç¼–è¾‘</a-button>
                        <a-button>å¤§æ¨¡å‹é‡æ–°åˆ¤å®š</a-button>
                    </div>
                </a-card>

                <a-card title="æ€»ä½“è¯„ä¼°æ„è§" :bordered="false" class="card-section">
                    <a-textarea v-model="form.overallOpinion" placeholder="ç‚¹å‡»è¾“å…¥è¯„ä¼°æ„è§"
                        :auto-size="{ minRows: 4, maxRows: 6 }" />
                    <a-button style="margin-left: 8px;" type="primary" class="opinion-assistant-btn">ä¿å­˜ç»“æœ</a-button>
                    <a-button style="margin-left: 8px;" @click="handleClick2" class="opinion-assistant-btn">è¿”å›åˆ—è¡¨</a-button>
                    <a-button style="margin-left: 8px;" class="opinion-assistant-btn">å¤§æ¨¡å‹ç”Ÿæˆ</a-button>
                    <a-button style="margin-left: 8px;" type="primary" class="opinion-assistant-btn" @click="handleText">æ–‡å­—èŠå¤©</a-button>
                    <a-button 
                        style="margin-left: 8px;" 
                        class="opinion-assistant-btn"
                        :type="isVoiceConnected ? 'danger' : 'default'"
                        @click="toggleVoiceConnection"
                    >                   
                        <a-icon :type="isVoiceConnected ? 'phone' : 'sound'" />
                            {{ isVoiceConnected ? 'æ–­å¼€è¯­éŸ³' : 'è¿æ¥è¯­éŸ³' }}
                    </a-button>
                    <a-button
                        v-if="isVoiceConnected"
                        style="margin-left: 8px;"
                        class="opinion-assistant-btn"
                        @click="toggleSelfMute"
                    >               
                    <a-icon :type="isMutedBySelf ? 'mic' : 'stop'" />
                        {{ isMutedBySelf ? 'å–æ¶ˆç¦éº¦' : 'éº¦å…‹é£é™éŸ³' }}
                    </a-button>
                    <a-button style="margin-left: 8px;" type="primary" class="opinion-assistant-btn" @click="handleHost">ä¸»æŒä¼šè®®</a-button>
                    <a-button style="margin-left: 8px;" class="opinion-assistant-btn">å¼€å§‹è¯„ä¼°</a-button>
                </a-card>
            </a-col>

            <a-col :span="10">
                <div class="retrieval-panel">
                    <h3 class="panel-title">æ•°æ®æ£€ç´¢</h3>
                    <a-form layout="vertical">
                        <a-form-item>
                             <label class="ant-form-item-label">è¯·é€‰æ‹©æ•°æ®æ¥æº</label>
                            <a-checkbox-group v-model="retrieval.sources">
                                <a-checkbox value="1">æ¼æ´éªŒè¯æ•°æ®</a-checkbox>
                                <a-checkbox value="2">æ¼æ´åœ°åŸŸ</a-checkbox>
                                <a-checkbox value="3">å„è¯„æµ‹ç®—æ³•è§£é‡Šæ•°æ®</a-checkbox>
                                <a-checkbox value="4">æ¼æ´å½±å“æ•°æ®</a-checkbox>
                                <a-checkbox value="5">å†å²åŒç±»æ¼æ´è¯„ä¼°æ¡ˆä¾‹æ•°æ®</a-checkbox>
                                <a-checkbox value="6">å¨èƒæƒ…æŠ¥</a-checkbox>
                            </a-checkbox-group>
                        </a-form-item>

                        <div class="retrieval-request-box">
                            <p class="box-title">æ•°æ®æ£€ç´¢è¦æ±‚</p>
                            <a-form-item label="æ—¶é—´èŒƒå›´">
                                <a-range-picker style="width: 100%;" v-model="retrieval.dateRange" />
                            </a-form-item>
                            <a-form-item label="å…³é”®è¯">
                                <a-input v-model="retrieval.keywords" placeholder="å…³é”®è¯ï¼šè¯·ç”¨è‹±æ–‡é€—å·éš”å¼€" />
                            </a-form-item>
                            <a-form-item label="æ¼æ´ç±»å‹">
                                <a-select v-model="retrieval.vulnType" placeholder="ç±»å‹ï¼šä¸‹æ‹‰åˆ—è¡¨é€‰æ‹©">
                                    <a-select-option value="type1">ç±»å‹ä¸€</a-select-option>
                                    <a-select-option value="type2">ç±»å‹äºŒ</a-select-option>
                                    <a-select-option value="type3">ç±»å‹ä¸‰</a-select-option>
                                </a-select>
                            </a-form-item>
                            <a-form-item label="å…¶ä»–éœ€æ±‚">
                                <a-input v-model="retrieval.other" placeholder="è¯·è¾“å…¥å…¶ä»–éœ€æ±‚, å¦‚: è¯·å¸®æˆ‘ä»¥è„‘å›¾çš„å½¢å¼è¾“å‡ºæ£€ç´¢ç»“æœ" />
                            </a-form-item>
                        </div>

                        <a-button type="primary" block>å¼€å§‹æ£€ç´¢</a-button>

                        <div class="retrieval-result-box">
                            <p class="box-title">æ•°æ®æ£€ç´¢ç»“æœ</p>
                            <a-radio-group v-model="retrieval.resultView" button-style="solid">
                                <a-radio-button value="table">è¡¨æ ¼</a-radio-button>
                                <a-radio-button value="line">æŠ˜çº¿å›¾</a-radio-button>
                                <a-radio-button value="pie">é¥¼çŠ¶å›¾</a-radio-button>
                                <a-radio-button value="llm">å¤§æ¨¡å‹ç”Ÿæˆç»“æœ</a-radio-button>
                            </a-radio-group>
                            <div class="display-area">
                                <p>å±•ç¤ºåŒºåŸŸ</p>
                            </div>
                        </div>
                            <a-button type="primary" block @click="shareData()" >å…±äº«æ•°æ®</a-button>
                    </a-form>
                </div>
            </a-col>
        </a-row>


        <a-modal
            title="ä¸»æŒä¼šè®®"
            :visible="hostModalVisible"
            @ok="handleHostModalOk"
            @cancel="handleHostModalCancel"
            :width="800"
            :maskClosable="false"
            :footer="null"
        >
            <div class="host-modal-content">
                <a-card title="å‚ä¼šä¸“å®¶ç®¡ç†" :bordered="false" class="experts-card">
                    <div class="experts-header">
                        <span class="experts-count">å…± {{ expertList.length }} ä½ä¸“å®¶</span>
                        <div class="global-controls">
                            <a-button type="primary" size="small" @click="muteAllExperts">
                                <a-icon type="stop" />å…¨ä½“ç¦è¨€
                            </a-button>
                            <a-button type="primary" size="small" @click="unmuteAllExperts" style="margin-left: 8px;">
                                <a-icon type="sound" />å…¨ä½“å‘è¨€
                            </a-button>
                        </div>
                    </div>
                    
                    <div class="experts-list">
                        <div 
                            v-for="expert in expertList" 
                            :key="expert.mpId" 
                            class="expert-item"
                            :class="{ 'muted': expert.isMuted }"
                        >
                            <div class="expert-info">
                                <a-avatar :src="expert.avatar" size="small" class="expert-avatar">
                                    {{ expert.name.charAt(0) }}
                                </a-avatar>
                                <div class="expert-details">
                                    <div class="expert-name">{{ expert.name }}</div>
                                    <div class="expert-role">{{ expert.role }}</div>
                                </div>
                                <div class="expert-status">
                                    <a-tag :color="expert.isMuted ? 'red' : 'green'">
                                        {{ expert.isMuted ? 'å·²ç¦è¨€' : 'å¯å‘è¨€' }}
                                    </a-tag>
                                </div>
                            </div>
                            <div class="expert-controls">
                                <a-button 
                                    :type="expert.isMuted ? 'primary' : 'default'"
                                    size="small"
                                    @click="toggleExpertMute(expert)"
                                >
                                    <a-icon :type="expert.isMuted ? 'sound' : 'stop'" />
                                    {{ expert.isMuted ? 'è§£é™¤ç¦è¨€' : 'ç¦è¨€' }}
                                </a-button>
                                <a-button
                                    v-if="expert.role !== 'ä¼šè®®ç®¡ç†å‘˜'"
                                    type="danger"
                                    size="small"
                                    @click="transferAdmin(expert)"
                                    style="margin-left: 8px;"
                                >
                                    <a-icon type="crown" />
                                    è½¬è®©ç®¡ç†å‘˜
                                </a-button>
                            </div>
                        </div>
                    </div>
                </a-card>

                <div class="modal-footer">
                    <a-button @click="handleHostModalCancel">å…³é—­</a-button>
                    <a-button type="primary" @click="handleHostModalOk">å¼€å§‹ä¼šè®®</a-button>
                </div>
            </div>
        </a-modal>

        <a-modal
            title="æ–‡å­—èŠå¤©"
            :visible="chatModalVisible"
            @cancel="handleChatModalCancel"
            :footer="null"
            :width="700"
            :maskClosable="false"
        >
            <div class="chat-modal-content">
                <div class="chat-history" ref="chatHistory">
                    <div v-for="(msg, index) in chatHistory" :key="index" class="chat-message">
                        <strong>{{ msg.user }} ({{ formatTimestamp(msg.timestamp) }}):</strong> {{ msg.text }}
                    </div>
                </div>
                <div class="chat-input-area">
                    <a-textarea 
                        v-model="newChatMessage"
                        placeholder="è¾“å…¥æ¶ˆæ¯ï¼ŒæŒ‰ Enter å‘é€"
                        :rows="3"
                        @pressEnter="handleSendMessage"
                    />
                    <a-button type="primary" @click="handleSendMessage" style="margin-top: 8px;">
                        å‘é€
                    </a-button>
                </div>
            </div>
        </a-modal>

        <a-modal
            title="ç¼–è¾‘ç®—æ³•å‚æ•°"
            :visible="algorithmModalVisible"
            @ok="handleAlgorithmSave"
            @cancel="handleAlgorithmCancel"
            :confirm-loading="modalLoading"
            okText="ä¿å­˜å¹¶é‡æ–°è®¡ç®—"
            cancelText="å–æ¶ˆ"
        >
            <p style="margin-bottom: 16px; color: #999;">ä¿®æ”¹ä»¥ä¸‹å‚æ•°åï¼Œå°†å‘é€è‡³æœåŠ¡å™¨è¿›è¡Œè¿ç®—ï¼Œå¹¶è¿”å›æ–°çš„è¯„ä¼°ç»“æœã€‚</p>
            <a-form>
                <a-form-item label="ç®—æ³•å‚æ•°A" :label-col="{ span: 6 }" :wrapper-col="{ span: 18 }">
                    <a-input v-model="algorithmParams.paramA" placeholder="è¯·è¾“å…¥å‚æ•°A" />
                </a-form-item>
                <a-form-item label="ç®—æ³•å‚æ•°B" :label-col="{ span: 6 }" :wrapper-col="{ span: 18 }">
                    <a-input v-model="algorithmParams.paramB" placeholder="è¯·è¾“å…¥å‚æ•°B" />
                </a-form-item>
                <a-form-item label="ç®—æ³•å‚æ•°C" :label-col="{ span: 6 }" :wrapper-col="{ span: 18 }">
                    <a-input v-model="algorithmParams.paramC" placeholder="è¯·è¾“å…¥å‚æ•°C" />
                </a-form-item>
                <a-form-item label="ç®—æ³•å‚æ•°D" :label-col="{ span: 6 }" :wrapper-col="{ span: 18 }">
                    <a-input v-model="algorithmParams.paramD" placeholder="è¯·è¾“å…¥å‚æ•°D" />
                </a-form-item>
                 <a-form-item label="ä¿®æ”¹ç†ç”±" :label-col="{ span: 6 }" :wrapper-col="{ span: 18 }">
                    <a-textarea v-model="algorithmParams.modificationReason" placeholder="è¯·è¾“å…¥ä¿®æ”¹ç†ç”±" :rows="4" />
                </a-form-item>
            </a-form>
        </a-modal>

        <a-modal
            title="ç¼–è¾‘å¯è§£é‡Šæ€§åˆ†æç»“æœ"
            :visible="explainabilityModalVisible"
            @ok="handleExplainabilitySave"
            @cancel="handleExplainabilityCancel"
            :confirm-loading="explainabilityModalLoading"
            okText="ä¿å­˜"
            cancelText="å–æ¶ˆ"
        >
            <p style="margin-bottom: 16px; color: #999;">è¯·ä¿®æ”¹ä»¥ä¸‹å­—æ®µï¼Œå¹¶å¡«å†™ä¿®æ”¹ç†ç”±ã€‚</p>
            <a-form>
                <a-form-item label="æ¼æ´ä»·å€¼" :label-col="{ span: 6 }" :wrapper-col="{ span: 18 }">
                    <a-select v-model="explainabilityParams.overallValue" placeholder="è¯·é€‰æ‹©">
                        <a-select-option value="ä¸¥é‡">ä¸¥é‡</a-select-option>
                        <a-select-option value="ä¸€èˆ¬">ä¸€èˆ¬</a-select-option>
                        <a-select-option value="è½»å¾®">è½»å¾®</a-select-option>
                    </a-select>
                </a-form-item>
                <a-form-item label="æš´éœ²åº¦" :label-col="{ span: 6 }" :wrapper-col="{ span: 18 }">
                     <a-select v-model="explainabilityParams.exposure" placeholder="è¯·é€‰æ‹©">
                        <a-select-option value="ä¸¥é‡">ä¸¥é‡</a-select-option>
                        <a-select-option value="ä¸€èˆ¬">ä¸€èˆ¬</a-select-option>
                        <a-select-option value="è½»å¾®">è½»å¾®</a-select-option>
                    </a-select>
                </a-form-item>
                <a-form-item label="æ¼æ´é£é™©" :label-col="{ span: 6 }" :wrapper-col="{ span: 18 }">
                     <a-select v-model="explainabilityParams.risk" placeholder="è¯·é€‰æ‹©">
                        <a-select-option value="ä¸¥é‡">ä¸¥é‡</a-select-option>
                        <a-select-option value="ä¸€èˆ¬">ä¸€èˆ¬</a-select-option>
                        <a-select-option value="è½»å¾®">è½»å¾®</a-select-option>
                    </a-select>
                </a-form-item>
                <a-form-item label="ä¿®æ”¹ç†ç”±" :label-col="{ span: 6 }" :wrapper-col="{ span: 18 }">
                    <a-textarea v-model="explainabilityParams.modificationReason" placeholder="è¯·è¾“å…¥ä¿®æ”¹ç†ç”±" :rows="4" />
                </a-form-item>
            </a-form>
        </a-modal>
    </div>
</template>

<script>
import { Button, Row, Col, Card, Form, Input, Checkbox, Radio, Select, DatePicker, Modal, message, Avatar, Tag, Icon } from 'ant-design-vue';
import api from '@/utils/axios';

// ã€æ–°å¢ã€‘å¯¼å…¥ WebSocket ç›¸å…³åº“
import SockJS from 'sockjs-client';
import { Client } from '@stomp/stompjs';

import { Room, RoomEvent } from 'livekit-client';

export default {
    name: 'VulnerabilityAssessment',
    components: {
        'a-button': Button,
        'a-row': Row,
        'a-col': Col,
        'a-card': Card,
        'a-form': Form,
        'a-form-item': Form.Item,
        'a-input': Input,
        'a-checkbox-group': Checkbox.Group,
        'a-checkbox': Checkbox,
        'a-radio-group': Radio.Group,
        'a-radio-button': Radio.Button,
        'a-select': Select,
        'a-select-option': Select.Option,
        'a-range-picker': DatePicker.RangePicker,
        'a-textarea': Input.TextArea,
        'a-modal': Modal,
        'a-avatar': Avatar,
        'a-tag': Tag,
        'a-icon': Icon,
    },
    data() {
        return {
            // WebSocket çŠ¶æ€ç®¡ç†
            stompClient: null,
            subscription: null,
            form: {
                basic: {
                    cveID: '',
                    cveType: '',
                    softwareType: '',
                    cveTitle: '',
                    cveDescription: '',
                },
                threatIntelligence: { field1: '', field2: '', field3: '' },
                religion:{ field1:'', field2:'', },
                autoSoft: { 
                    value: '',
                    weapon: '',
                    service: '',
                    exploitability: '',
                },
                explain: {
                    overallValue: '',
                    exposure: '',
                    risk: '',
                },
                overallOpinion: '',
            },
            retrieval: {
                sources: [], dateRange: [], keywords: '',
                vulnType: undefined, other: '', resultView: 'table',
            },
            hostModalVisible: false,
            chatModalVisible: false,
            newChatMessage: '',
            chatHistory: [],
            expertList: [], 
            // ç®—æ³•å¼¹çª—
            algorithmModalVisible: false,
            modalLoading: false,
            algorithmParams: {
                paramA: 'é»˜è®¤å€¼1',
                paramB: 'é»˜è®¤å€¼2',
                paramC: 'é»˜è®¤å€¼3',
                paramD: 'é»˜è®¤å€¼4',
                modificationReason: '', 
            },
            // å¯è§£é‡Šæ€§å¼¹çª—
            explainabilityModalVisible: false,
            explainabilityModalLoading: false,
            explainabilityParams: {
                overallValue: undefined,
                exposure: undefined,
                risk: undefined,
                modificationReason: '',
            },
            livekitRoom: null, // LiveKit Room å®ä¾‹
            isVoiceConnected: false, // æ˜¯å¦å·²è¿æ¥åˆ°è¯­éŸ³
            isMutedBySelf: false, // æ˜¯å¦è‡ªå·±é™éŸ³äº†éº¦å…‹é£
        }
    },
    created() {
        this.fetchDetails();
        this.fetchChatHistory();
        this.initWebSocket();
    },
    beforeDestroy() {
        this.disconnectWebSocket();
        if (this.livekitRoom) {
            this.livekitRoom.disconnect();
        }
    },
    methods: {
        formatTimestamp(timestamp) {
            if (!timestamp) return '';
            return new Date(timestamp).toLocaleString();
        },

        // åˆå§‹åŒ– WebSocket 
        initWebSocket() {
            const meetingId = this.$route.query.meetingId;
            if (!meetingId) {
                message.error("æ— æ³•è·å–ä¼šè®®ID,æ— æ³•è¿æ¥èŠå¤©å®¤");
                return;
            }

            const authToken = this.$store.getters['auth/authToken'];

            this.stompClient = new Client({
                brokerURL: 'ws://127.0.0.1:8080/ws', 
                webSocketFactory: () => new SockJS('http://127.0.0.1:8080/ws'),
                connectHeaders: {
                  Authorization: authToken,
                },
                reconnectDelay: 5000,
            });

            this.stompClient.onConnect = frame => {
                console.log('Connected to WebSocket: ' + frame);
                message.success('æˆåŠŸè¿æ¥åˆ°ä¼šè®®èŠå¤©å®¤ï¼');

                this.subscription = this.stompClient.subscribe('/topic/meeting/' + meetingId, (message) => {
                    const receivedMsg = JSON.parse(message.body);
                    
                    if (receivedMsg.type === "CHAT" && receivedMsg.payload) {
                        this.chatHistory.push({
                            user: receivedMsg.userAccount || 'æœªçŸ¥ç”¨æˆ·',
                            text: receivedMsg.payload,
                            timestamp: receivedMsg.timestamp 
                        });

                        this.$nextTick(() => {
                            const chatHistoryEl = this.$refs.chatHistory;
                            if(chatHistoryEl) { chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight; }
                        });
                    }
                });
            };

            this.stompClient.onStompError = frame => {
                console.error('Broker reported error: ' + frame.headers['message']);
                message.error('èŠå¤©å‘ç”Ÿé”™è¯¯: ' + frame.headers['message']);
            };

            this.stompClient.activate();
        },

        // æ–­å¼€ WebSocket è¿æ¥
        disconnectWebSocket() {
            if (this.subscription) {
                this.subscription.unsubscribe();
                this.subscription = null;
            }
            if (this.stompClient) {
                this.stompClient.deactivate();
                this.stompClient = null;
                console.log('WebSocket disconnected.');
            }
        },

        async fetchDetails() {
            const id = this.$route.query.id; 
            if (!id) {
                message.error('æ— æ³•è·å–æ¼æ´ID,è¯·è¿”å›åˆ—è¡¨é‡è¯•ã€‚');
                return;
            }
            try {
                const response = await api.get(`/api/eval/${id}`);
                if (response.data.succeed) {
                    const data = response.data.data;
                    if (data.vulnInfo) {
                        this.form.basic.cveID = data.vulnInfo.cveId;
                        this.form.basic.cveType = data.vulnInfo.cveType;
                        this.form.basic.softwareType = data.vulnInfo.softwareType;
                        this.form.basic.cveTitle = data.vulnInfo.cveTitle;
                        this.form.basic.cveDescription = data.vulnInfo.cveDescription;
                    }
                    if (data.threatIntel) {
                        this.form.threatIntelligence.field1 = data.threatIntel.field1;
                        this.form.threatIntelligence.field2 = data.threatIntel.field2;
                        this.form.threatIntelligence.field3 = data.threatIntel.field3;
                    }
                    if (data.dimVOList && Array.isArray(data.dimVOList)) {
                        data.dimVOList.forEach(item => {
                            switch (item.dimensionCode) {
                                case 'æ¼æ´ä»·å€¼': this.form.autoSoft.value = item.originalEvalValue; break;
                                case 'æ¼æ´æ­¦å™¨': this.form.autoSoft.weapon = item.originalEvalValue; break;
                                case 'æ¼æ´æœåŠ¡': this.form.autoSoft.service = item.originalEvalValue; break;
                                case 'æ¼æ´å¯åˆ©ç”¨æ€§': this.form.autoSoft.exploitability = item.originalEvalValue; break;
                            }
                        });
                    }
                    if (data.metricVOList && Array.isArray(data.metricVOList)) {
                        data.metricVOList.forEach(item => {
                            switch (item.metricCode) {
                                case 'æ¼æ´ä»·å€¼': this.form.explain.overallValue = item.originalAnalysisRate; break;
                                case 'æ¼æ´æš´éœ²åº¦': this.form.explain.exposure = item.originalAnalysisRate; break;
                                case 'æ¼æ´é£é™©': this.form.explain.risk = item.originalAnalysisRate; break;
                            }
                        });
                    }
                    this.form.overallOpinion = data.evalReportContent;
                    message.success(`æˆåŠŸåŠ è½½æ¼æ´ ${id} çš„è¯¦æƒ…ã€‚`);
                } else {
                    message.error('è·å–æ¼æ´è¯¦æƒ…å¤±è´¥: ' + (response.data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error("è·å–è¯¦æƒ…å¤±è´¥:", error);
                message.error('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–è”ç³»ç®¡ç†å‘˜ã€‚');
            }
        },

        // è¿”å›åˆ—è¡¨å‰ï¼Œå…ˆæ–­å¼€è¿æ¥
        handleClick2() { 
            this.disconnectWebSocket(); 
            this.$router.push('/multiexpert'); 
        },

        handleText() { this.chatModalVisible = true; },
        handleChatModalCancel() { this.chatModalVisible = false; },

        // ä½¿ç”¨ WebSocket å‘é€æ¶ˆæ¯
        async handleSendMessage() {
            if (!this.newChatMessage.trim()) return;
            if (!this.stompClient || !this.stompClient.active) {
                message.error("èŠå¤©å®¤æœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯ï¼");
                return;
            }

            try {
                const meetingId = this.$route.query.meetingId;
                const userId = this.$store.getters['auth/userId'];
                const userInfo = this.$store.getters['auth/userInfo'];

                const chatMessage = {
                    meetingId: meetingId,
                    expertId: userId,
                    userAccount: userInfo ? userInfo.account : 'æœªçŸ¥ç”¨æˆ·',
                    type: 'CHAT',
                    payload: this.newChatMessage,
                    timestamp: Date.now()
                };

                this.stompClient.publish({
                    destination: '/app/chat',
                    body: JSON.stringify(chatMessage),
                });

                this.newChatMessage = '';

            } catch (error) {
                message.error("å‘é€æ¶ˆæ¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åˆ·æ–°é‡è¯•ã€‚");
                console.error("Send message error:", error);
            }
        },

        handleHost(){ 
            this.hostModalVisible = true;
            this.getMeetingMembers();
        },
        handleHostModalOk() { this.hostModalVisible = false; message.success('ä¼šè®®å·²å¼€å§‹'); },
        handleHostModalCancel() { this.hostModalVisible = false; },

        async fetchChatHistory(){
            const meetingId = this.$route.query.meetingId;
            if(!meetingId){
                message.error("æ— æ³•è·å¾—ä¼šè®®id");
                return;
            }
            try {
                const response =await api.get('api/meeting-record/list',{
                    params:{ meetingId }
                });
                if(response.data.succeed){
                    const data = response.data.data;
                    this.chatHistory = data.slice().reverse().map(msg =>({
                        ...msg,
                        user: msg.userAccount,
                        text: msg.msgContent,
                        timestamp: msg.recordCreated
                    }));
                }else{
                    message.error("è·å–æ¶ˆæ¯å†å²å¤±è´¥",response.data);
                }
            } catch (error) {
                message.error("è·å–æ–‡å­—èŠå¤©å†å²ä¿¡æ¯å¤±è´¥");
                console.log(error);
            }
        },
        async getMeetingMembers() {
            const meetingId = this.$route.query.meetingId;
            if (!meetingId) {
                message.error("æ— æ³•è·å–ä¼šè®®ID,è¯·ä»åˆ—è¡¨é¡µé‡æ–°è¿›å…¥ã€‚");
                return;
            }
            try {
                // è°ƒç”¨å‚ä¼šæˆå‘˜æŸ¥è¯¢æ¥å£ 
                const response = await api.get(`/api/mp/list/${meetingId}`,{
                    params:{
                        expertId: this.$store.getters['auth/userId'],
                    }
                });
                if (response.data && response.data.succeed) {
                    this.expertList = response.data.data.map(expert => ({
                        ...expert,
                        name: expert.expertName,
                        role: expert.meetingRole,
                        isMuted: expert.speakStatus === 'å·²ç¦è¨€', 
                        avatar: '' 
                    }));
                    console.log(this.expertList);
                } else {
                    message.error("è·å–å‚ä¼šæˆå‘˜åˆ—è¡¨å¤±è´¥: " + (response.data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error("è·å–å‚ä¼šæˆå‘˜åˆ—è¡¨å¤±è´¥:", error);
                message.error('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥æˆ–è”ç³»ç®¡ç†å‘˜ã€‚'+error);
            }
        },

        async toggleExpertMute(expert) {
            const newStatus = expert.isMuted ? 'å¯å‘è¨€' : 'å·²ç¦è¨€'; 
            try { 
                const response = await api.put('/api/mp/speak', {
                    mpId: expert.mpId,
                    expertId: expert.expertId,
                    speakStatus: newStatus
                }); 
                if (response.data && response.data.succeed) { 
                    expert.isMuted = !expert.isMuted;
                    expert.speakStatus = newStatus;
                    message.success(`${expert.name} ${newStatus === 'å¯å‘è¨€' ? 'å·²è§£é™¤ç¦è¨€' : 'å·²ç¦è¨€'}`);
                } else {
                    message.error('æ“ä½œå¤±è´¥: ' + (response.data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error("ç¦è¨€/è§£ç¦æ“ä½œå¤±è´¥:", error);
                message.error('ç½‘ç»œè¯·æ±‚å¤±è´¥');
            }
        },

        async setAllMuteStatus(mute) {
            const newStatus = mute ? 'å·²ç¦è¨€' : 'å¯å‘è¨€';
            const actionName = mute ? 'ç¦è¨€' : 'è§£ç¦';
            const promises = this.expertList
                .filter(expert => expert.role !== 'ä¼šè®®ç®¡ç†å‘˜')
                .map(expert => {
                    return api.put('/api/mp/speak', {  
                        mpId: expert.mpId,
                        expertId: expert.expertId,
                        speakStatus: newStatus
                    }).then(res => {
                        if(res.data && res.data.succeed) {
                            expert.isMuted = mute;
                            expert.speakStatus = newStatus;
                        }
                    });
                });

            try {
                await Promise.all(promises);
                message.success(`å…¨ä½“æˆå‘˜ï¼ˆé™¤ç®¡ç†å‘˜å¤–ï¼‰å·²${actionName}`);
            } catch(error) {
                console.error(`å…¨ä½“${actionName}å¤±è´¥:`, error);
                message.error(`å…¨ä½“${actionName}æ“ä½œæ—¶å‘ç”Ÿç½‘ç»œé”™è¯¯`);
                this.getMeetingMembers(); // å‘ç”Ÿé”™è¯¯æ—¶ï¼Œé‡æ–°åŒæ­¥çŠ¶æ€
            }
        },

        muteAllExperts() { this.setAllMuteStatus(true); },
        unmuteAllExperts() { this.setAllMuteStatus(false); },
        
        transferAdmin(targetExpert) {
            const currentAdmin = this.expertList.find(e => e.role === 'ä¼šè®®ç®¡ç†å‘˜');
            if (!currentAdmin) {
                message.error("é”™è¯¯ï¼šæœªæ‰¾åˆ°å½“å‰ä¼šè®®ç®¡ç†å‘˜ã€‚");
                return;
            }
            
            Modal.confirm({
                title: 'ç¡®è®¤è½¬è®©ç®¡ç†å‘˜',
                content: `æ‚¨ç¡®å®šè¦å°†ç®¡ç†å‘˜æƒé™è½¬è®©ç»™ã€${targetExpert.name}ã€‘å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ã€‚`,
                okText: 'ç¡®è®¤è½¬è®©',
                cancelText: 'å–æ¶ˆ',
                onOk: async () => {
                    try {
                        const promoteResponse = await api.put('/api/mp/role', { 
                            mpId: targetExpert.mpId,
                            expertId: targetExpert.expertId,
                            meetingRole: 'ä¼šè®®ç®¡ç†å‘˜'
                        });

                        if (!promoteResponse.data || !promoteResponse.data.succeed) { 
                            message.error(`æå‡${targetExpert.name}ä¸ºç®¡ç†å‘˜å¤±è´¥: ${promoteResponse.data.message || 'æœªçŸ¥é”™è¯¯'}`);
                            return;
                        }
                        
                        message.success('ç®¡ç†å‘˜å·²æˆåŠŸè½¬è®©!');
                        await this.getMeetingMembers();
                        this.hostModalVisible = false;
                        this.$router.push({ path: '/multiexpert/detail', query: { id: this.$route.query.id, meetingId:this.$route.query.meetingId  } });
                    } catch (error) {
                        console.error("ç®¡ç†å‘˜è½¬è®©å¤±è´¥:", error);
                        message.error('ç½‘ç»œè¯·æ±‚å¤±è´¥ï¼Œç®¡ç†å‘˜è½¬è®©æ“ä½œæœªå®Œæˆã€‚');
                        this.getMeetingMembers();
                    }
                },
            });
        },

        showAlgorithmModal() {
            this.algorithmParams.modificationReason = '';
            this.algorithmModalVisible = true;
        },
        handleAlgorithmSave() {
            if (!this.algorithmParams.modificationReason) {
                message.warn('è¯·è¾“å…¥ä¿®æ”¹ç†ç”±');
                return;
            }
            this.modalLoading = true;
            console.log("æ­£åœ¨å°†ä»¥ä¸‹å‚æ•°å‘é€åˆ°æœåŠ¡å™¨:", this.algorithmParams);
            setTimeout(() => {
                try {
                    this.modalLoading = false;
                    this.algorithmModalVisible = false;
                    message.success('å‚æ•°å·²æ›´æ–°ï¼Œè¯„ä¼°ç»“æœå·²é‡æ–°è®¡ç®—ï¼');
                } catch (error) {
                    this.modalLoading = false;
                }
            }, 1500);
        },
        handleAlgorithmCancel() { this.algorithmModalVisible = false; },
        
        showExplainabilityModal() {
            this.explainabilityParams.overallValue = this.form.explain.overallValue || undefined;
            this.explainabilityParams.exposure = this.form.explain.exposure || undefined;
            this.explainabilityParams.risk = this.form.explain.risk || undefined;
            this.explainabilityParams.modificationReason = '';
            this.explainabilityModalVisible = true;
        },
        handleExplainabilitySave() {
            if (!this.explainabilityParams.modificationReason) {
                message.warn('è¯·è¾“å…¥ä¿®æ”¹ç†ç”±');
                return;
            }
            if (!this.explainabilityParams.overallValue || !this.explainabilityParams.exposure || !this.explainabilityParams.risk) {
                message.warn('è¯·å®Œæˆæ‰€æœ‰å­—æ®µçš„é€‰æ‹©');
                return;
            }
            this.explainabilityModalLoading = true;
            console.log("æ­£åœ¨ä¿å­˜å¯è§£é‡Šæ€§åˆ†æç»“æœ:", this.explainabilityParams);
            setTimeout(() => {
                this.form.explain.overallValue = this.explainabilityParams.overallValue;
                this.form.explain.exposure = this.explainabilityParams.exposure;
                this.form.explain.risk = this.explainabilityParams.risk;
                message.success('å¯è§£é‡Šæ€§åˆ†æç»“æœå·²æ›´æ–°ï¼');
                this.explainabilityModalLoading = false;
                this.explainabilityModalVisible = false;
            }, 1000);
        },
        handleExplainabilityCancel() { this.explainabilityModalVisible = false; },
        toggleVoiceConnection() {
            if (this.isVoiceConnected) {
                this.disconnectFromVoice();
            } else {
                this.connectToVoice();
            }
        },

        async connectToVoice() {
            const meetingId = this.$route.query.meetingId;
            const userInfo = this.$store.getters['auth/userInfo'];

            if (!meetingId || !userInfo) {
                message.error("æ— æ³•è·å–ä¼šè®®æˆ–ç”¨æˆ·ä¿¡æ¯ï¼Œæ— æ³•åŠ å…¥è¯­éŸ³ã€‚");
                return;
            }

            try {
                // 1. åç«¯è·å– Token
                const response = await api.post('/api/livekit/token', {
                    roomName: `meeting-${meetingId}`, 
                    participantIdentity: userInfo.account, 
                });

                const { token } = response.data;
                if (!token) {
                    message.error("è·å–è¯­éŸ³æˆæƒå¤±è´¥ï¼");
                    return;
                }

                // 2. åˆ›å»ºå¹¶è¿æ¥åˆ° Room
                this.livekitRoom = new Room();
                const livekitUrl = 'ws://10.13.1.104:7880'; 

                message.info('æ­£åœ¨è¿æ¥è¯­éŸ³æœåŠ¡...');
                await this.livekitRoom.connect(livekitUrl, token);

                this.livekitRoom
            .on(RoomEvent.TrackSubscribed, (track, publication, participant) => {
                console.log('âœ… æˆåŠŸè®¢é˜…åˆ°æ–°çš„è½¨é“', {
                    trackSid: track.sid,
                    kind: track.kind,
                    participant: participant.identity
                });
                if (track.kind === 'audio') {
                    const element = track.attach(); 
                    // å°†è¿™ä¸ªå…ƒç´ ç›´æ¥æ·»åŠ åˆ°é¡µé¢çš„ body ä¸­ï¼Œä½¿å…¶å¯ä»¥æ’­æ”¾å£°éŸ³
                    document.body.appendChild(element); 
                }
            })
            .on(RoomEvent.TrackSubscriptionFailed, (trackSid, participant) => {
                console.error('âŒ è®¢é˜…è½¨é“å¤±è´¥', {
                    trackSid: trackSid,
                    participant: participant.identity
                });
                // è¿™ä¸ªäº‹ä»¶æ˜¯è¯Šæ–­é—®é¢˜çš„å…³é”®ï¼
            })
            .on(RoomEvent.ConnectionStateChanged, (state) => {
                console.log('ğŸ”— è¿æ¥çŠ¶æ€æ”¹å˜:', state);
                // è§‚å¯ŸçŠ¶æ€æ˜¯å¦ä» connecting -> connected
            });

                // 3. æˆåŠŸè¿æ¥åï¼Œå¼€å¯éº¦å…‹é£
                await this.livekitRoom.localParticipant.setMicrophoneEnabled(true);

                this.isVoiceConnected = true;
                this.isMutedBySelf = false;
                message.success('è¯­éŸ³å·²è¿æ¥ï¼');

                //  ç›‘å¬å…¶ä»–äº‹ä»¶
                this.livekitRoom.on(RoomEvent.ParticipantConnected, (participant) => {
                    message.info(`${participant.identity} åŠ å…¥äº†è¯­éŸ³ã€‚`);
                });
                this.livekitRoom.on(RoomEvent.ParticipantDisconnected, (participant) => {
                    message.warn(`${participant.identity} ç¦»å¼€äº†è¯­éŸ³ã€‚`);
                });

            } catch (error) {
                console.error("è¿æ¥è¯­éŸ³å¤±è´¥:", error);
                message.error("è¿æ¥è¯­éŸ³å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–è”ç³»ç®¡ç†å‘˜ã€‚");
                if (this.livekitRoom) {
                    this.livekitRoom.disconnect();
                    this.livekitRoom = null;
                }
            }
        },

        async disconnectFromVoice() {
            if (this.livekitRoom) {
            // åœ¨æ–­å¼€è¿æ¥å‰ï¼Œå…ˆæ‰‹åŠ¨åœæ­¢æ‰€æœ‰æœ¬åœ°è½¨é“çš„å‘å¸ƒï¼Œç‰¹åˆ«æ˜¯éº¦å…‹é£
            this.livekitRoom.localParticipant.setMicrophoneEnabled(false);

            // ä½¿ç”¨ await ç¡®ä¿æ–­å¼€æ“ä½œå®Œæˆåå†ç»§ç»­
            await this.livekitRoom.disconnect();
        
            // æ›´æ–°å‰ç«¯çŠ¶æ€
            this.livekitRoom = null;
            this.isVoiceConnected = false;
            message.warn('è¯­éŸ³å·²æ–­å¼€ã€‚');
            }
        },

        // åˆ‡æ¢è‡ªå·±çš„éº¦å…‹é£çŠ¶æ€
        toggleSelfMute() {
            if (!this.livekitRoom) return;
            const newMuteState = !this.isMutedBySelf;
            this.livekitRoom.localParticipant.setMicrophoneEnabled(!newMuteState);
            this.isMutedBySelf = newMuteState;
            message.info(newMuteState ? 'éº¦å…‹é£å·²é™éŸ³' : 'éº¦å…‹é£å·²å¼€å¯');
        }
    },
}
</script>

<style scoped>
.vulnerability-assessment-container {
    padding: 24px;
    background-color: #F7F8FB;
    font-family: "Microsoft YaHei", "å¾®è½¯é›…é»‘", sans-serif;
    color: #666666;
    font-size: 12px;
}
.ant-form-text {
    display: inline-block;
    min-height: 32px;
    line-height: 32px;
    width: 100%;
    padding: 0 11px;
    color: #666666;
    background-color: #f5f5f5;
    border: 1px solid #d9d9d9;
    border-radius: 4px;
    word-break: break-all;
}
.card-section>>>.ant-card-head-title,
.panel-title {
    font-size: 14px !important; 
    color: #333333 !important; 
}
.vulnerability-assessment-container >>> .ant-btn-primary {
    background-color: #2BBAFF;
    border-color: #2BBAFF; 
}
.vulnerability-assessment-container >>> .ant-btn-primary:hover,
.vulnerability-assessment-container >>> .ant-btn-primary:focus {
    background-color: #26649D;
    border-color: #26649D; 
}
.vulnerability-assessment-container >>> .ant-btn-primary:active {
    background-color: #20507a;
    border-color: #20507a;
}
.vulnerability-assessment-container >>> .ant-btn:not(.ant-btn-primary) {
    background-color: #FFFFFF;
    border: 1px solid #d9d9d9;
    color: #666666;
}
.vulnerability-assessment-container >>> .ant-btn:not(.ant-btn-primary):hover,
.vulnerability-assessment-container >>> .ant-btn:not(.ant-btn-primary):focus {
    border-color: #2BBAFF;
    color: #2BBAFF;
}
.vulnerability-assessment-container >>> .ant-input:focus,
.vulnerability-assessment-container >>> .ant-input:hover,
.vulnerability-assessment-container >>> .ant-input-affix-wrapper:focus,
.vulnerability-assessment-container >>> .ant-input-affix-wrapper:hover,
.vulnerability-assessment-container >>> .ant-select-selection:hover,
.vulnerability-assessment-container >>> .ant-select-open .ant-select-selection,
.vulnerability-assessment-container >>> .ant-select-focused .ant-select-selection,
.vulnerability-assessment-container >>> .ant-calendar-picker:hover .ant-input {
    border-color: #2BBAFF;
    box-shadow: 0 0 0 2px rgba(43, 186, 255, 0.2);
}
.vulnerability-assessment-container >>> .ant-checkbox-checked .ant-checkbox-inner {
    background-color: #2BBAFF;
    border-color: #2BBAFF;
}
.vulnerability-assessment-container >>> .ant-checkbox-wrapper:hover .ant-checkbox-inner,
.vulnerability-assessment-container >>> .ant-checkbox:hover .ant-checkbox-inner,
.vulnerability-assessment-container >>> .ant-checkbox-input:focus+.ant-checkbox-inner {
    border-color: #2BBAFF;
}
.vulnerability-assessment-container >>> .ant-radio-button-wrapper-checked:not(.ant-radio-button-wrapper-disabled) {
    background: #2BBAFF;
    border-color: #2BBAFF;
    color: #fff;
}
.vulnerability-assessment-container >>> .ant-radio-button-wrapper-checked:not(.ant-radio-button-wrapper-disabled):hover {
    background: #26649D;
    border-color: #26649D;
}
.card-section {
    margin-bottom: 16px;
    background-color: #FFFFFF;
}
.card-section>>>.ant-card-body {
    padding: 16px;
}
.card-section>>>.ant-card-head {
    min-height: 48px;
    padding: 0 16px;
}
.card-section::after {
    content: '';
    display: table;
    clear: both;
}
.ant-form-item {
    margin-bottom: 12px;
}
.ant-form-vertical .ant-form-item-label {
    padding-bottom: 4px !important;
}
.opinion-assistant-btn {
    margin-top: 8px;
    float: right;
}
.footer-buttons {
    margin-top: 24px;
    text-align: left;
}
.retrieval-panel {
    background-color: #fff;
    padding: 24px;
    border-radius: 2px;
    height: 100%;
}
.panel-title {
    font-weight: 500;
    margin-bottom: 16px;
}
.ant-checkbox-group {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
}
.ant-checkbox-wrapper {
    margin-left: 0 !important;
    margin-bottom: 8px;
}
.retrieval-request-box,
.retrieval-result-box {
    border: 1px solid #d9d9d9;
    padding: 16px;
    margin-top: 16px;
    margin-bottom: 16px;
    border-radius: 2px;
}
.box-title {
    font-weight: 500;
    margin-bottom: 12px;
    color: #333333;
    font-size: 13px;
}
.retrieval-result-box .ant-radio-group {
    margin-bottom: 16px;
}
.display-area {
    border: 1px dashed #d9d9d9;
    min-height: 150px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #bfbfbf;
    background-color: #fafafa;
    border-radius: 2px;
}
.host-modal-content {
    padding: 16px 0;
}
.experts-card {
    margin-bottom: 16px;
}
.experts-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid #f0f0f0;
}
.experts-count {
    font-size: 14px;
    color: #666;
    font-weight: 500;
}
.global-controls {
    display: flex;
    gap: 8px;
}
.experts-list {
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 16px;
}
.expert-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px;
    margin-bottom: 8px;
    border: 1px solid #f0f0f0;
    border-radius: 6px;
    background-color: #fafafa;
    transition: all 0.3s ease;
}
.expert-item:hover {
    background-color: #f5f5f5;
    border-color: #d9d9d9;
}
.expert-item.muted {
    background-color: #fff2f0;
    border-color: #ffccc7;
}
.expert-info {
    display: flex;
    align-items: center;
    flex: 1;
}
.expert-avatar {
    margin-right: 12px;
    background-color: #2BBAFF;
}
.expert-details {
    flex: 1;
}
.expert-name {
    font-size: 14px;
    font-weight: 500;
    color: #333;
    margin-bottom: 4px;
}
.expert-role {
    font-size: 12px;
    color: #666;
}
.expert-status {
    margin-left: 12px;
}
.expert-controls {
    display: flex;
    align-items: center;
}
.add-expert-section {
    padding-top: 16px;
    border-top: 1px solid #f0f0f0;
}
.modal-footer {
    text-align: right;
    padding-top: 16px;
    border-top: 1px solid #f0f0f0;
    margin-top: 16px;
}
.modal-footer .ant-btn {
    margin-left: 8px;
}
.chat-history {
    height: 350px;
    overflow-y: auto;
    border: 1px solid #f0f0f0;
    padding: 12px;
    margin-bottom: 16px;
    background-color: #fafafa;
    border-radius: 4px;
}
.chat-message {
    margin-bottom: 10px;
    line-height: 1.5;
}
.chat-message strong {
    color: #26649D;
}
.chat-input-area {
    text-align: right;
}
</style>